# plot average INP concentrations, summed over entire vertical column, on a North Polar Stereo projection map 

import iris
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.colors as mcols
import cartopy.crs as ccrs
import cartopy.feature as cfeature
import pandas as pd

# ASH_file = ['ASH201004141200.nc', 'ASH201004141800.nc', 'ASH201004150000.nc', 'ASH201004150600.nc', 'ASH201004151200.nc', 'ASH201004151800.nc', 'ASH201004160000.nc', 'ASH201004160600.nc', 'ASH201004161200.nc', 'ASH201004161800.nc', 'ASH201004170000.nc', 'ASH201004170600.nc', 'ASH201004171200.nc', 'ASH201004171800.nc', 'ASH201004180000.nc', 'ASH201004180600.nc', 'ASH201004181200.nc', 'ASH201004181800.nc', 'ASH201004190000.nc', 'ASH201004190600.nc', 'ASH201004191200.nc', 'ASH201004191800.nc', 'ASH201004200000.nc', 'ASH201004200600.nc', 'ASH201004201200.nc', 'ASH201004201800.nc', 'ASH201004210000.nc', 'ASH201004210600.nc', 'ASH201004211200.nc', 'ASH201004211800.nc', 'ASH201004220000.nc', 'ASH201004220600.nc', 'ASH201004221200.nc', 'ASH201004221800.nc', 'ASH201004230000.nc', 'ASH201004230600.nc', 'ASH201004231200.nc', 'ASH201004231800.nc', 'ASH201004240000.nc', 'ASH201004240600.nc', 'ASH201004241200.nc', 'ASH201004241800.nc', 'ASH201004250000.nc', 'ASH201004250600.nc', 'ASH201004251200.nc', 'ASH201004251800.nc', 'ASH201004260000.nc', 'ASH201004260600.nc', 'ASH201004261200.nc', 'ASH201004261800.nc', 'ASH201004270000.nc', 'ASH201004270600.nc', 'ASH201004271200.nc', 'ASH201004271800.nc', 'ASH201004280000.nc', 'ASH201004280600.nc', 'ASH201004281200.nc', 'ASH201004281800.nc', 'ASH201004290000.nc', 'ASH201004290600.nc', 'ASH201004291200.nc', 'ASH201004291800.nc', 'ASH201004300000.nc', 'ASH201004300600.nc', 'ASH201004301200.nc', 'ASH201004301800.nc', 'ASH201005010000.nc', 'ASH201005010600.nc', 'ASH201005011200.nc', 'ASH201005011800.nc', 'ASH201005020000.nc', 'ASH201005020600.nc', 'ASH201005021200.nc', 'ASH201005021800.nc', 'ASH201005030000.nc', 'ASH201005030600.nc', 'ASH201005031200.nc', 'ASH201005031800.nc', 'ASH201005040000.nc', 'ASH201005040600.nc', 'ASH201005041200.nc', 'ASH201005041800.nc', 'ASH201005050000.nc', 'ASH201005050600.nc', 'ASH201005051200.nc', 'ASH201005051800.nc', 'ASH201005060000.nc', 'ASH201005060600.nc', 'ASH201005061200.nc', 'ASH201005061800.nc', 'ASH201005070000.nc', 'ASH201005070600.nc', 'ASH201005071200.nc', 'ASH201005071800.nc', 'ASH201005080000.nc', 'ASH201005080600.nc', 'ASH201005081200.nc', 'ASH201005081800.nc', 'ASH201005090000.nc', 'ASH201005090600.nc', 'ASH201005091200.nc', 'ASH201005091800.nc', 'ASH201005100000.nc', 'ASH201005100600.nc', 'ASH201005101200.nc', 'ASH201005101800.nc', 'ASH201005110000.nc', 'ASH201005110600.nc', 'ASH201005111200.nc', 'ASH201005111800.nc', 'ASH201005120000.nc', 'ASH201005120600.nc', 'ASH201005121200.nc', 'ASH201005121800.nc', 'ASH201005130000.nc', 'ASH201005130600.nc', 'ASH201005131200.nc', 'ASH201005131800.nc', 'ASH201005140000.nc', 'ASH201005140600.nc', 'ASH201005141200.nc', 'ASH201005141800.nc', 'ASH201005150000.nc', 'ASH201005150600.nc', 'ASH201005151200.nc', 'ASH201005151800.nc', 'ASH201005160000.nc', 'ASH201005160600.nc', 'ASH201005161200.nc', 'ASH201005161800.nc', 'ASH201005170000.nc', 'ASH201005170600.nc', 'ASH201005171200.nc', 'ASH201005171800.nc', 'ASH201005180000.nc', 'ASH201005180600.nc', 'ASH201005181200.nc', 'ASH201005181800.nc', 'ASH201005190000.nc', 'ASH201005190600.nc', 'ASH201005191200.nc', 'ASH201005191800.nc', 'ASH201005200000.nc', 'ASH201005200600.nc']
# TEMP_file = ['TEMP201004141200.nc', 'TEMP201004141800.nc', 'TEMP201004150000.nc', 'TEMP201004150600.nc', 'TEMP201004151200.nc', 'TEMP201004151800.nc', 'TEMP201004160000.nc', 'TEMP201004160600.nc', 'TEMP201004161200.nc', 'TEMP201004161800.nc', 'TEMP201004170000.nc', 'TEMP201004170600.nc', 'TEMP201004171200.nc', 'TEMP201004171800.nc', 'TEMP201004180000.nc', 'TEMP201004180600.nc', 'TEMP201004181200.nc', 'TEMP201004181800.nc', 'TEMP201004190000.nc', 'TEMP201004190600.nc', 'TEMP201004191200.nc', 'TEMP201004191800.nc', 'TEMP201004200000.nc', 'TEMP201004200600.nc', 'TEMP201004201200.nc', 'TEMP201004201800.nc', 'TEMP201004210000.nc', 'TEMP201004210600.nc', 'TEMP201004211200.nc', 'TEMP201004211800.nc', 'TEMP201004220000.nc', 'TEMP201004220600.nc', 'TEMP201004221200.nc', 'TEMP201004221800.nc', 'TEMP201004230000.nc', 'TEMP201004230600.nc', 'TEMP201004231200.nc', 'TEMP201004231800.nc', 'TEMP201004240000.nc', 'TEMP201004240600.nc', 'TEMP201004241200.nc', 'TEMP201004241800.nc', 'TEMP201004250000.nc', 'TEMP201004250600.nc', 'TEMP201004251200.nc', 'TEMP201004251800.nc', 'TEMP201004260000.nc', 'TEMP201004260600.nc', 'TEMP201004261200.nc', 'TEMP201004261800.nc', 'TEMP201004270000.nc', 'TEMP201004270600.nc', 'TEMP201004271200.nc', 'TEMP201004271800.nc', 'TEMP201004280000.nc', 'TEMP201004280600.nc', 'TEMP201004281200.nc', 'TEMP201004281800.nc', 'TEMP201004290000.nc', 'TEMP201004290600.nc', 'TEMP201004291200.nc', 'TEMP201004291800.nc', 'TEMP201004300000.nc', 'TEMP201004300600.nc', 'TEMP201004301200.nc', 'TEMP201004301800.nc', 'TEMP201005010000.nc', 'TEMP201005010600.nc', 'TEMP201005011200.nc', 'TEMP201005011800.nc', 'TEMP201005020000.nc', 'TEMP201005020600.nc', 'TEMP201005021200.nc', 'TEMP201005021800.nc', 'TEMP201005030000.nc', 'TEMP201005030600.nc', 'TEMP201005031200.nc', 'TEMP201005031800.nc', 'TEMP201005040000.nc', 'TEMP201005040600.nc', 'TEMP201005041200.nc', 'TEMP201005041800.nc', 'TEMP201005050000.nc', 'TEMP201005050600.nc', 'TEMP201005051200.nc', 'TEMP201005051800.nc', 'TEMP201005060000.nc', 'TEMP201005060600.nc', 'TEMP201005061200.nc', 'TEMP201005061800.nc', 'TEMP201005070000.nc', 'TEMP201005070600.nc', 'TEMP201005071200.nc', 'TEMP201005071800.nc', 'TEMP201005080000.nc', 'TEMP201005080600.nc', 'TEMP201005081200.nc', 'TEMP201005081800.nc', 'TEMP201005090000.nc', 'TEMP201005090600.nc', 'TEMP201005091200.nc', 'TEMP201005091800.nc', 'TEMP201005100000.nc', 'TEMP201005100600.nc', 'TEMP201005101200.nc', 'TEMP201005101800.nc', 'TEMP201005110000.nc', 'TEMP201005110600.nc', 'TEMP201005111200.nc', 'TEMP201005111800.nc', 'TEMP201005120000.nc', 'TEMP201005120600.nc', 'TEMP201005121200.nc', 'TEMP201005121800.nc', 'TEMP201005130000.nc', 'TEMP201005130600.nc', 'TEMP201005131200.nc', 'TEMP201005131800.nc', 'TEMP201005140000.nc', 'TEMP201005140600.nc', 'TEMP201005141200.nc', 'TEMP201005141800.nc', 'TEMP201005150000.nc', 'TEMP201005150600.nc', 'TEMP201005151200.nc', 'TEMP201005151800.nc', 'TEMP201005160000.nc', 'TEMP201005160600.nc', 'TEMP201005161200.nc', 'TEMP201005161800.nc', 'TEMP201005170000.nc', 'TEMP201005170600.nc', 'TEMP201005171200.nc', 'TEMP201005171800.nc', 'TEMP201005180000.nc', 'TEMP201005180600.nc', 'TEMP201005181200.nc', 'TEMP201005181800.nc', 'TEMP201005190000.nc', 'TEMP201005190600.nc', 'TEMP201005191200.nc', 'TEMP201005191800.nc', 'TEMP201005200000.nc', 'TEMP201005200600.nc']
INP_file = ['INP201004141200.nc', 'INP201004141800.nc', 'INP201004150000.nc', 'INP201004150600.nc', 'INP201004151200.nc', 'INP201004151800.nc', 'INP201004160000.nc', 'INP201004160600.nc', 'INP201004161200.nc', 'INP201004161800.nc', 'INP201004170000.nc', 'INP201004170600.nc', 'INP201004171200.nc', 'INP201004171800.nc', 'INP201004180000.nc', 'INP201004180600.nc', 'INP201004181200.nc', 'INP201004181800.nc', 'INP201004190000.nc', 'INP201004190600.nc', 'INP201004191200.nc', 'INP201004191800.nc', 'INP201004200000.nc', 'INP201004200600.nc', 'INP201004201200.nc', 'INP201004201800.nc', 'INP201004210000.nc', 'INP201004210600.nc', 'INP201004211200.nc', 'INP201004211800.nc', 'INP201004220000.nc', 'INP201004220600.nc', 'INP201004221200.nc', 'INP201004221800.nc', 'INP201004230000.nc', 'INP201004230600.nc', 'INP201004231200.nc', 'INP201004231800.nc', 'INP201004240000.nc', 'INP201004240600.nc', 'INP201004241200.nc', 'INP201004241800.nc', 'INP201004250000.nc', 'INP201004250600.nc', 'INP201004251200.nc', 'INP201004251800.nc', 'INP201004260000.nc', 'INP201004260600.nc', 'INP201004261200.nc', 'INP201004261800.nc', 'INP201004270000.nc', 'INP201004270600.nc', 'INP201004271200.nc', 'INP201004271800.nc', 'INP201004280000.nc', 'INP201004280600.nc', 'INP201004281200.nc', 'INP201004281800.nc', 'INP201004290000.nc', 'INP201004290600.nc', 'INP201004291200.nc', 'INP201004291800.nc', 'INP201004300000.nc', 'INP201004300600.nc', 'INP201004301200.nc', 'INP201004301800.nc', 'INP201005010000.nc', 'INP201005010600.nc', 'INP201005011200.nc', 'INP201005011800.nc', 'INP201005020000.nc', 'INP201005020600.nc', 'INP201005021200.nc', 'INP201005021800.nc', 'INP201005030000.nc', 'INP201005030600.nc', 'INP201005031200.nc', 'INP201005031800.nc', 'INP201005040000.nc', 'INP201005040600.nc', 'INP201005041200.nc', 'INP201005041800.nc', 'INP201005050000.nc', 'INP201005050600.nc', 'INP201005051200.nc', 'INP201005051800.nc', 'INP201005060000.nc', 'INP201005060600.nc', 'INP201005061200.nc', 'INP201005061800.nc', 'INP201005070000.nc', 'INP201005070600.nc', 'INP201005071200.nc', 'INP201005071800.nc', 'INP201005080000.nc', 'INP201005080600.nc', 'INP201005081200.nc', 'INP201005081800.nc', 'INP201005090000.nc', 'INP201005090600.nc', 'INP201005091200.nc', 'INP201005091800.nc', 'INP201005100000.nc', 'INP201005100600.nc', 'INP201005101200.nc', 'INP201005101800.nc', 'INP201005110000.nc', 'INP201005110600.nc', 'INP201005111200.nc', 'INP201005111800.nc', 'INP201005120000.nc', 'INP201005120600.nc', 'INP201005121200.nc', 'INP201005121800.nc', 'INP201005130000.nc', 'INP201005130600.nc', 'INP201005131200.nc', 'INP201005131800.nc', 'INP201005140000.nc', 'INP201005140600.nc', 'INP201005141200.nc', 'INP201005141800.nc', 'INP201005150000.nc', 'INP201005150600.nc', 'INP201005151200.nc', 'INP201005151800.nc', 'INP201005160000.nc', 'INP201005160600.nc', 'INP201005161200.nc', 'INP201005161800.nc', 'INP201005170000.nc', 'INP201005170600.nc', 'INP201005171200.nc', 'INP201005171800.nc', 'INP201005180000.nc', 'INP201005180600.nc', 'INP201005181200.nc', 'INP201005181800.nc', 'INP201005190000.nc', 'INP201005190600.nc', 'INP201005191200.nc', 'INP201005191800.nc', 'INP201005200000.nc', 'INP201005200600.nc']

# create dataframe for ease of sorting and naming files
def date_df(lst):
    
    time_list = []
    name_list = []
    for i in range(len(lst)):
        time_list.append(lst[i][-15:-3])
    for i in lst:
        name_list.append(i[-15:-3])
    df = pd.DataFrame({'date' : time_list, 'name' : name_list})
    df['date'] = pd.to_datetime(df['date'])
    df = df.sort_values(by = 'date')
    df['sorted_index'] = [i for i in range(len(time_list))]
    return df

df = date_df(INP_file)

minimum_log_level = 0.001
maximum_log_level = 10000
cmap = 'PuBu' #  color scheme, see https://matplotlib.org/stable/tutorials/colors/colormaps.html 
norm = mcols.SymLogNorm(linthresh = minimum_log_level, vmin = 0, vmax = maximum_log_level) # create a logarithmic data normalization
ccont_levels = [10**i for i in range(-3, 5)] # colour contour levels
cbar_ticks = [10** i for i in range(-3, 5)] # colour bar ticks

# plot data using North Polar Stereo Projection
for i in range(len(ASH_file)):
    title = df['date'][i]
    
    # ASHcube = iris.load_cube(ASH_file[i])
    # ASHdata = ASHcube.data
    
    # TEMPcube = iris.load_cube(TEMP_file[i])
    # TEMPdata = TEMPcube.data
    
    INPcube = iris.load_cube(INP_file[i])
    INPdata = INPcube.data
    
    alt = INPcube.coord('altitude').points
    lat = INPcube[:, :383, :].coord('latitude').points # remove latitude = 90 data point (bug fix)
    lon = INPcube.coord('longitude').points
    
    # collapse data over altitude (mean concentration over entire vertical column)
    INPcube_altmean = INPcube[:, :383, :].collapsed('altitude', iris.analysis.MEAN)
    INPdata_altmean = INPcube_altmean.data
    
    x1, y1 = np.meshgrid(lon, lat)
    
    fig = plt.figure(figsize = (10, 10))
    ax = fig.add_subplot(1, 1, 1, projection = ccrs.NorthPolarStereo()) # https://scitools.org.uk/cartopy/docs/v0.15/crs/projections.html
    ax.patch.set_visible(False)
    extent = [-6600000, 6600000, -7000000, 7000000] # size of domain plotted
    ax.set_extent(extent, ccrs.NorthPolarStereo())
    ax.gridlines()
    ax.coastlines(resolution = '50m')
    ax.add_feature(cfeature.LAND.with_scale('50m'))
    ax.set_title('Mean INP Air Concentration Over Entire Vertical Column - ' + str(title))
    cs = ax.contourf(x1[:, :], y1[:, :], INPdata_altmean[:, :], levels = ccont_levels, transform = ccrs.PlateCarree(), cmap = cmap, norm = norm)
    plt.colorbar(cs, orientation = 'horizontal', ticks = cbar_ticks, label = '# / L')
    
    # plt.show()
    # save plots as .png files, with format 'mean_INPYYYYMMDDHHHH.png'
    fig.savefig('mean_INP' + df['name'][i] + '.png')
